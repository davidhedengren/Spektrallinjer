<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Spektroskopi – Diffraktionsgitter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      text-align: center;
    }
    #controls {
      padding: 10px;
      background: #222;
    }
    #controls label {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h1>Spektroskopi – Diffraktionsgitter</h1>
  <div id="controls">
    <label for="elementSelect">Välj ämne:</label>
    <select id="elementSelect">
      <option value="hydrogen">Väte (H)</option>
      <option value="mercury">Kvicksilver (Hg)</option>
      <option value="sodium">Natrium (Na)</option>
      <option value="neon">Neon (Ne)</option>
      <option value="cadmium">Kadmium (Cd)</option>
      <option value="helium">Helium (He)</option>
      <option value="calcium">Kalcium (Ca)</option>
      <option value="argon">Argon (Ar)</option>
      <option value="lithium">Litium (Li)</option>
      <option value="magnesium">Magnesium (Mg)</option>
    </select>
    <br>
    <label for="gitterSlider">Gitterkonstant (d):</label>
    <!-- Standard inställt på 2000 nm -->
    <input type="range" id="gitterSlider" min="5" max="6000" value="2000" step="5">
    <span id="gitterValue">2000</span> nm
    <br>
    <label for="tiltSlider">Gittervinkel (grader):</label>
    <input type="range" id="tiltSlider" min="-10" max="10" value="0" step="0.1">
    <span id="tiltValue">0</span>
    <br>
    <label for="secondOrder">Andra ordningen</label>
    <input type="checkbox" id="secondOrder">
    <br>
    <label for="thirdOrder">Tredje ordningen</label>
    <input type="checkbox" id="thirdOrder">
  </div>

  <script>
    /* Färgkarta: definierar RGB-värden för de angivna färgerna */
    const colorMapping = {
      "Röd": [255, 0, 0],
      "Blågrön": [0, 200, 200],
      "Blå": [0, 0, 255],
      "Violett": [238, 130, 238],
      "Grön": [0, 255, 0],
      "Gul": [255, 255, 0],
      "Djupröd": [139, 0, 0],
      "Orange": [255, 165, 0],
      "UV": [75, 0, 130]
    };

    /* Spektratabell med de angivna värdena */
    const spectra = {
      hydrogen: [
        { wavelength: 656.3, color: "Röd", intensity: 75 },
        { wavelength: 486.1, color: "Blågrön", intensity: 75 },
        { wavelength: 434.0, color: "Blå", intensity: 50 },
        { wavelength: 410.2, color: "Violett", intensity: 25 }
      ],
      mercury: [
        { wavelength: 404.7, color: "Violett", intensity: 50 },
        { wavelength: 435.8, color: "Blå", intensity: 75 },
        { wavelength: 546.1, color: "Grön", intensity: 100 },
        { wavelength: 577.0, color: "Gul", intensity: 50 },
        { wavelength: 579.0, color: "Gul", intensity: 50 }
      ],
      sodium: [
        { wavelength: 589.0, color: "Gul", intensity: 100 },
        { wavelength: 589.6, color: "Gul", intensity: 100 }
      ],
      neon: [
        { wavelength: 633.4, color: "Röd", intensity: 100 },
        { wavelength: 667.8, color: "Röd", intensity: 100 },
        { wavelength: 703.2, color: "Djupröd", intensity: 75 }
      ],
      cadmium: [
        { wavelength: 467.8, color: "Blå", intensity: 75 },
        { wavelength: 508.6, color: "Grön", intensity: 75 },
        { wavelength: 643.8, color: "Röd", intensity: 75 }
      ],
      helium: [
        { wavelength: 587.6, color: "Gul", intensity: 100 },
        { wavelength: 447.1, color: "Blå", intensity: 75 },
        { wavelength: 667.8, color: "Röd", intensity: 75 }
      ],
      calcium: [
        { wavelength: 393.4, color: "Violett", intensity: 75 },
        { wavelength: 396.8, color: "Violett", intensity: 75 },
        { wavelength: 422.7, color: "Blå", intensity: 75 }
      ],
      argon: [
        { wavelength: 696.5, color: "Röd", intensity: 75 },
        { wavelength: 706.7, color: "Röd", intensity: 75 },
        { wavelength: 738.4, color: "Röd", intensity: 75 }
      ],
      lithium: [
        { wavelength: 670.8, color: "Röd", intensity: 100 },
        { wavelength: 610.4, color: "Orange", intensity: 50 }
      ],
      magnesium: [
        { wavelength: 279.55, color: "UV", intensity: 75 },
        { wavelength: 279.81, color: "UV", intensity: 75 },
        { wavelength: 518.4, color: "Grön", intensity: 75 }
      ]
    };

    // Globala variabler
    let currentElement = "hydrogen";
    let elementLines = [];
    // Standard gitterkonstant: 2000 nm
    let gitterKonstant = 2000;
    const gitterX = 300;  // Fast position
    let tiltAngleDeg = 0;  // Gittervinkel (grader)
    let showSecondOrder = false;
    let showThirdOrder = false;

    // Canvasparametrar
    const canvasWidth = 800, canvasHeight = 600;
    const lampX = 100, screenX = 700;
    const L = 400;

    // Returnerar en p5.color med alfavärde inställt enligt intensitet (0–100 → 0–255)
    function getLineColor(lineData) {
      let base = colorMapping[lineData.color];
      if (!base) base = [255, 255, 255];
      let alpha = (lineData.intensity / 100) * 255;
      return color(base[0], base[1], base[2], alpha);
    }

    function setup() {
      createCanvas(canvasWidth, canvasHeight);
      updateElementLines();

      document.getElementById("elementSelect").addEventListener("change", function() {
        currentElement = this.value;
        updateElementLines();
      });

      document.getElementById("gitterSlider").addEventListener("input", function() {
        gitterKonstant = parseInt(this.value);
        document.getElementById("gitterValue").innerText = gitterKonstant;
      });

      document.getElementById("tiltSlider").addEventListener("input", function() {
        tiltAngleDeg = parseFloat(this.value);
        document.getElementById("tiltValue").innerText = tiltAngleDeg;
      });
      
      document.getElementById("secondOrder").addEventListener("change", function() {
        showSecondOrder = this.checked;
      });
      
      document.getElementById("thirdOrder").addEventListener("change", function() {
        showThirdOrder = this.checked;
      });
    }

    function updateElementLines() {
      elementLines = spectra[currentElement] || [];
    }

    // Beräknar lampans färg som ett intensitetsviktat medelvärde
    function computeLampColor() {
      let rTotal = 0, gTotal = 0, bTotal = 0, totIntensity = 0;
      for (let lineData of elementLines) {
        let base = colorMapping[lineData.color] || [255, 255, 255];
        let I = lineData.intensity;
        rTotal += base[0] * I;
        gTotal += base[1] * I;
        bTotal += base[2] * I;
        totIntensity += I;
      }
      return totIntensity > 0 ? color(rTotal / totIntensity, gTotal / totIntensity, bTotal / totIntensity) : color(255,204,0);
    }

    function draw() {
      background(20);
      drawLamp();
      drawGitter();
      drawStrålar();
      drawDiffractionPatterns();
      drawCentralMax();
      drawWavelengthScale();

      // Visa vilka ordningar som visas (minst första ordningen visas)
      fill(255);
      noStroke();
      textSize(16);
      textAlign(RIGHT, TOP);
      let ordersText = "Ordning: 1" +
                       (showSecondOrder ? ", 2" : "") +
                       (showThirdOrder ? ", 3" : "");
      text(ordersText, canvasWidth - 10, 10);
    }

    function drawLamp() {
      let lampColor = computeLampColor();
      fill(lampColor);
      ellipse(lampX, 250, 50, 50);
    }

    function drawGitter() {
      fill(150);
      rect(gitterX, 200, 10, 100);
    }

    // Rita diffraktionsstrålar – endast för våglängder 400–750 nm (de "synliga")
    function drawStrålar() {
      strokeWeight(2);
      for (let lineData of elementLines) {
        let lambda = lineData.wavelength;
        // Om linjen ligger utanför det synliga intervallet (400–750 nm) ritas den inte
        if (lambda < 400 || lambda > 750) continue;
        let lineCol = getLineColor(lineData);
        stroke(lineCol);
        line(lampX + 25, 250, gitterX, 250);
        drawOrder(lineData, 1);
        if (showSecondOrder) drawOrder(lineData, 2);
        if (showThirdOrder) drawOrder(lineData, 3);
      }
    }

    // Rita en viss ordning (m) för en given linje, endast om våglängden är 400–750 nm
    function drawOrder(lineData, m) {
      let lambda = lineData.wavelength;
      if (lambda < 400 || lambda > 750) return;
      let ratio = (m * lambda) / gitterKonstant;
      if (ratio > 1) return;
      let theta = asin(ratio);
      let thetaUpper = theta + tiltAngleDeg * (PI / 180);
      let thetaLower = theta - tiltAngleDeg * (PI / 180);
      let yOffsetUpper = tan(thetaUpper) * L;
      let yOffsetLower = tan(thetaLower) * L;
      let yCenter = 250;
      stroke(getLineColor(lineData));
      line(gitterX, 250, screenX, yCenter - yOffsetUpper);
      line(gitterX, 250, screenX, yCenter + yOffsetLower);
    }

    function drawDiffractionPatterns() {
      strokeWeight(3);
      for (let lineData of elementLines) {
        // Rita endast diffraktionsmönster för våglängder 400–750 nm
        if (lineData.wavelength < 400 || lineData.wavelength > 750) continue;
        drawDiffractionLine(lineData, 1);
        if (showSecondOrder) drawDiffractionLine(lineData, 2);
        if (showThirdOrder) drawDiffractionLine(lineData, 3);
      }
    }

    function drawDiffractionLine(lineData, m) {
      let lambda = lineData.wavelength;
      let ratio = (m * lambda) / gitterKonstant;
      if (ratio > 1) return;
      let theta = asin(ratio);
      let thetaUpper = theta + tiltAngleDeg * (PI / 180);
      let thetaLower = theta - tiltAngleDeg * (PI / 180);
      let yOffsetUpper = tan(thetaUpper) * L;
      let yOffsetLower = tan(thetaLower) * L;
      let yCenter = 250;
      stroke(getLineColor(lineData));
      line(screenX, yCenter - yOffsetUpper, canvasWidth, yCenter - yOffsetUpper);
      line(screenX, yCenter + yOffsetLower, canvasWidth, yCenter + yOffsetLower);
    }

    // Rita centralmaximum (m = 0)
    function drawCentralMax() {
      let lampColor = computeLampColor();
      stroke(lampColor);
      strokeWeight(4);
      let yCenter = 250;
      line(screenX, yCenter, canvasWidth, yCenter);
    }

    // Ritning av våglängdsskalan – alla linjer (även utanför 400–750 nm) visas med fasta färger
    function drawWavelengthScale() {
      let scaleHeight = 50;
      let scaleY = 460;
      let wlMin = 250, wlMax = 1000;
      
      // Övre remsa: regnbågsspektrum – använder wavelengthToColor
      for (let x = 0; x < canvasWidth; x++) {
        let wl = map(x, 0, canvasWidth, wlMin, wlMax);
        stroke(wavelengthToColor(wl));
        line(x, scaleY, x, scaleY + scaleHeight);
      }
      // Tickmarkeringar var 10 nm, längre vid var 50:e nm
      stroke(255);
      strokeWeight(1);
      for (let wl = wlMin; wl <= wlMax; wl += 10) {
        let x = map(wl, wlMin, wlMax, 0, canvasWidth);
        if (wl % 50 === 0) {
          line(x, scaleY, x, scaleY - 10);
          noStroke();
          fill(255);
          textSize(10);
          textAlign(CENTER, BOTTOM);
          text(wl + " nm", x, scaleY - 12);
          stroke(255);
        } else {
          line(x, scaleY, x, scaleY - 5);
        }
      }
      // Nedre remsa: svart bakgrund med tunna, färgade markeringsstreck och växelvis placerade etiketter
      let markerStripY = scaleY + scaleHeight + 30;
      fill(0);
      rect(0, markerStripY, canvasWidth, 20);
      for (let i = 0; i < elementLines.length; i++) {
        let lineData = elementLines[i];
        let wl = lineData.wavelength;
        let x = map(wl, wlMin, wlMax, 0, canvasWidth);
        stroke(wavelengthToColor(wl));
        strokeWeight(2);
        line(x, markerStripY, x, markerStripY + 20);
        noStroke();
        fill(255);
        textSize(10);
        if (i % 2 === 0) {
          textAlign(CENTER, BOTTOM);
          text(wl + " nm", x, markerStripY - 2);
        } else {
          textAlign(CENTER, TOP);
          text(wl + " nm", x, markerStripY + 22);
        }
      }
    }

    // Returnerar färgen för våglängder inom 380–750 nm (synliga)
    function getColorForVisible(wavelength) {
      let R = 0, G = 0, B = 0;
      if (wavelength >= 380 && wavelength < 440) { 
        R = -(wavelength - 440) / (440 - 380); 
        G = 0.0; 
        B = 1.0; 
      } else if (wavelength >= 440 && wavelength < 490) { 
        R = 0.0; 
        G = (wavelength - 440) / (490 - 440); 
        B = 1.0; 
      } else if (wavelength >= 490 && wavelength < 510) { 
        R = 0.0; 
        G = 1.0; 
        B = -(wavelength - 510) / (510 - 490); 
      } else if (wavelength >= 510 && wavelength < 580) { 
        R = (wavelength - 510) / (580 - 510); 
        G = 1.0; 
        B = 0.0; 
      } else if (wavelength >= 580 && wavelength < 645) { 
        R = 1.0; 
        G = -(wavelength - 645) / (645 - 580); 
        B = 0.0; 
      } else if (wavelength >= 645 && wavelength <= 750) { 
        R = 1.0; 
        G = 0.0; 
        B = 0.0; 
      }
      return color(R * 255, G * 255, B * 255);
    }

    // Modifierad funktion: för våglängder utanför 400–750 nm, returneras fasta färger (UV: violett, IR: röd)
    function wavelengthToColor(wavelength) {
      if (wavelength < 400) {
         return color(238, 130, 238);  // Violett (UV)
      } else if (wavelength > 750) {
         return color(255, 0, 0);      // Röd (IR)
      } else {
         return getColorForVisible(wavelength);
      }
    }
  </script>
</body>
</html>
